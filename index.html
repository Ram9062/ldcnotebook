<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LDC Notebook</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ffffff" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .entry-row:hover { background-color: #f3f4f6; }
    .entry-row.selected { background-color: #e0f2fe !important; }
    body.lock-scroll { overflow: hidden; }
    #networkStatus.online { background-color: #22c55e; }
    #networkStatus.offline { background-color: #ef4444; }
    #networkStatus.syncing { background-color: #facc15; color: #000; }
  </style>
</head>
<body class="bg-gray-100 p-4">

  <!-- Login Overlay -->
  <div id="loginOverlay" class="fixed inset-0 bg-white flex items-center justify-center z-50">
    <div class="bg-white border rounded-lg shadow-lg p-6 w-full max-w-sm">
      <h2 class="text-xl font-semibold mb-4">LDC Login</h2>
      <input id="phoneInput" type="text" placeholder="Phone Number" class="mb-3 w-full border px-3 py-2 rounded" />
      <input id="passInput" type="password" placeholder="Password" class="mb-4 w-full border px-3 py-2 rounded" />
      <button onclick="handleLogin()" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Login</button>
      <p id="loginError" class="text-red-600 text-sm mt-3 hidden">Invalid credentials.</p>
    </div>
  </div>

  <!-- Sticky Header -->
  <div class="sticky top-0 bg-gray-100 z-10 pb-4 border-b border-gray-300">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold">LDC Notebook</h1>
        <p class="mt-1 text-sm text-gray-600">Total Entries: <span id="entryCount">0</span></p>
      </div>
      <div class="flex flex-col sm:flex-row sm:items-center gap-2 w-full sm:w-auto">
        <div class="flex items-center gap-2">
          <div id="topDeleteIcon" title="Delete Selected Row"
              class="hidden text-red-500 hover:text-red-700 text-2xl cursor-pointer">
            üóëÔ∏è
          </div>
          <input type="date" id="entryDate" class="border rounded px-3 py-2 text-base w-full sm:w-auto" />
        </div>
        <button onclick="addEntry()" class="bg-blue-500 text-white px-4 py-2 rounded w-full sm:w-auto">
          Add Entry
        </button>
      </div>
    </div>
  </div>

  <!-- Network Status Bar -->
  <div id="networkStatus" class="hidden mb-2 text-sm text-white px-4 py-2 rounded text-center transition duration-300"></div>

  <!-- Entry Section -->
  <div class="bg-white shadow rounded-lg p-4">
    <div class="hidden sm:grid grid-cols-4 font-semibold mb-2 gap-2">
      <span>Customer Name</span>
      <span>Time</span>
      <span>Driver Name</span>
      <span></span>
    </div>
    <div id="entriesContainer" class="overflow-y-auto pr-1 max-h-[calc(100vh-220px)] sm:max-h-[70vh]"></div>
  </div>

  <script>
    const SYNC_URL = "YOUR_WEB_APP_URL_HERE"; // Replace with your Google Apps Script URL

    const entryDate = document.getElementById('entryDate');
    const entriesContainer = document.getElementById('entriesContainer');
    const entryCount = document.getElementById('entryCount');
    const topDeleteIcon = document.getElementById('topDeleteIcon');
    const networkStatus = document.getElementById('networkStatus');

    const FIXED_PHONE = "9062538991";
    const FIXED_PASSWORD = "9090";
    const LOGIN_DURATION_HOURS = 12;

    let selectedRow = null;

    function isLoggedIn() {
      const token = JSON.parse(localStorage.getItem("ldcLogin"));
      if (!token) return false;
      const now = Date.now();
      const diff = (now - token.timestamp) / (1000 * 60 * 60); // hours
      return diff < LOGIN_DURATION_HOURS;
    }

    function showLogin() {
      document.getElementById("loginOverlay").classList.remove("hidden");
    }

    function hideLogin() {
      document.getElementById("loginOverlay").classList.add("hidden");
    }

    function handleLogin() {
      const phone = document.getElementById("phoneInput").value.trim();
      const password = document.getElementById("passInput").value.trim();
      const error = document.getElementById("loginError");

      if (phone === FIXED_PHONE && password === FIXED_PASSWORD) {
        const token = { phone, timestamp: Date.now() };
        localStorage.setItem("ldcLogin", JSON.stringify(token));
        hideLogin();
        initApp();
      } else {
        error.classList.remove("hidden");
      }
    }

    function logout() {
      localStorage.removeItem("ldcLogin");
      location.reload();
    }

    function getStorageKey() {
      return `entries-${entryDate.value}`;
    }

    async function loadEntries() {
      entriesContainer.innerHTML = '';
      selectedRow = null;
      hideTopDelete();

      const dateKey = entryDate.value;
      let saved = [];

      try {
        if (navigator.onLine) {
          const res = await fetch(`${SYNC_URL}?date=${dateKey}`);
          const data = await res.json();
          saved = data.entries || [];
          localStorage.setItem(getStorageKey(), JSON.stringify(saved));
        } else {
          saved = JSON.parse(localStorage.getItem(getStorageKey())) || [];
        }
      } catch (err) {
        console.error("‚ùå Failed to load from Google Sheet, using local cache");
        saved = JSON.parse(localStorage.getItem(getStorageKey())) || [];
      }

      saved.sort((a, b) => {
        const [ah, am] = a.time.split(':').map(Number);
        const [bh, bm] = b.time.split(':').map(Number);
        return ah * 60 + am - (bh * 60 + bm);
      });

      saved.forEach(entry => {
        createEntryElement(entry.customer, entry.time, entry.driver);
      });
      updateCount();
    }

    function saveEntries() {
      const entries = [];
      entriesContainer.querySelectorAll('.entry-row').forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        entries.push({
          customer: inputs[0].value,
          time: inputs[1].value,
          driver: inputs[2].value
        });
      });
      localStorage.setItem(getStorageKey(), JSON.stringify(entries));
      syncToGoogleSheet();
      loadEntries();
    }

    function createEntryElement(customer = '', time = '', driver = '') {
      const div = document.createElement('div');
      div.className = 'grid grid-cols-1 sm:grid-cols-4 gap-2 mb-4 p-2 rounded entry-row items-center relative';
      div.onclick = (e) => {
        if (['INPUT', 'SELECT', 'BUTTON'].includes(e.target.tagName)) return;
        selectRow(div);
      };

      div.innerHTML = `
        <div class="relative">
          <input type="text" class="border px-3 py-2 rounded w-full pr-10" placeholder="Customer Name" value="${customer}" onchange="saveEntries()" />
          <button title="Add to Contacts" class="absolute right-2 top-2 text-green-600 text-xl" onclick="event.stopPropagation(); downloadContact(this)">‚ûï</button>
        </div>
        <select class="border px-3 py-2 rounded w-full" onchange="saveEntries()">
          ${generateTimeOptions(time)}
        </select>
        <input type="text" class="border px-3 py-2 rounded w-full" placeholder="Driver Name" value="${driver}" onchange="saveEntries()"/>
        <div></div>
      `;
      entriesContainer.appendChild(div);
      updateCount();
    }

    function generateTimeOptions(selected = '') {
      const options = [];
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 30) {
          const hour12 = h % 12 === 0 ? 12 : h % 12;
          const minuteStr = m.toString().padStart(2, '0');
          const ampm = h < 12 ? 'AM' : 'PM';
          const display = `${hour12}:${minuteStr} ${ampm}`;
          const value = `${h.toString().padStart(2, '0')}:${minuteStr}`;
          const selectedAttr = selected === value ? 'selected' : '';
          options.push(`<option value="${value}" ${selectedAttr}>${display}</option>`);
        }
      }
      return options.join('');
    }

    function addEntry() {
      createEntryElement();
    }

    function deleteSelectedRow() {
      if (selectedRow) {
        selectedRow.remove();
        selectedRow = null;
        hideTopDelete();
        updateCount();
        saveEntries();
      }
    }

    function updateCount() {
      entryCount.textContent = entriesContainer.querySelectorAll('.entry-row').length;
    }

    function selectRow(row) {
      document.querySelectorAll('.entry-row').forEach(r => r.classList.remove('selected'));
      selectedRow = row;
      row.classList.add('selected');
      showTopDelete();
    }

    function showTopDelete() {
      topDeleteIcon.classList.remove('hidden');
    }

    function hideTopDelete() {
      topDeleteIcon.classList.add('hidden');
    }

    topDeleteIcon.addEventListener('click', deleteSelectedRow);

    function downloadContact(button) {
      const row = button.closest('.entry-row');
      const inputs = row.querySelectorAll('input, select');
      const name = inputs[0].value.trim();
      const driver = inputs[2].value.trim();

      if (!name) {
        alert("Customer name is required to add to contacts.");
        return;
      }

      const vcf = `
BEGIN:VCARD
VERSION:3.0
FN:${name}
ORG:LDC Notebook
NOTE:Driver: ${driver}
END:VCARD
      `.trim();

      const blob = new Blob([vcf], { type: 'text/vcard' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name.replace(/\s+/g, '_')}.vcf`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function syncToGoogleSheet() {
      if (!navigator.onLine) return;

      const entries = [];
      const currentDate = entryDate.value;

      entriesContainer.querySelectorAll('.entry-row').forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        entries.push({
          date: currentDate,
          customer: inputs[0].value,
          time: inputs[1].value,
          driver: inputs[2].value
        });
      });

      showStatus("Syncing to Google Sheet...", "syncing");

      fetch(SYNC_URL, {
        method: "POST",
        body: JSON.stringify(entries),
        headers: { "Content-Type": "application/json" }
      }).then(res => {
        showStatus("‚úÖ Synced to Google Sheet", "online");
        setTimeout(() => hideStatus(), 3000);
      }).catch(err => {
        console.error("‚ùå Sync failed:", err);
        showStatus("‚ùå Sync failed. Will retry later.", "offline");
      });
    }

    setInterval(syncToGoogleSheet, 30000); // auto-sync every 30s

    function showStatus(message, type = "online") {
      networkStatus.textContent = message;
      networkStatus.className = `mb-2 text-sm px-4 py-2 rounded text-center ${type}`;
      networkStatus.classList.remove("hidden");
    }

    function hideStatus() {
      networkStatus.classList.add("hidden");
    }

    function updateNetworkStatus() {
      if (navigator.onLine) {
        showStatus("You are online ‚úÖ", "online");
        setTimeout(() => hideStatus(), 3000);
      } else {
        showStatus("You're offline üö´. Changes will be saved locally.", "offline");
      }
    }

    function initApp() {
      updateNetworkStatus();
      entryDate.valueAsDate = new Date();
      entryDate.addEventListener('change', loadEntries);
      loadEntries();
    }

    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);

    if (isLoggedIn()) {
      hideLogin();
      initApp();
    } else {
      showLogin();
    }

    // PWA support
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
