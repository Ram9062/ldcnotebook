<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LDC Notebook</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .entry-row:hover { background-color: #f3f4f6; }
    .entry-row.selected { background-color: #e0f2fe !important; }
    body.lock-scroll { overflow: hidden; }
  </style>
</head>
<body class="bg-gray-100 p-4">

  <!-- Sync Status Bar -->
  <div id="syncStatus" class="fixed top-0 left-0 right-0 text-center text-white text-sm py-1 hidden z-50"></div>

  <!-- Sticky Header -->
  <div class="sticky top-8 bg-gray-100 z-10 pb-4 border-b border-gray-300">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold">LDC Notebook</h1>
        <p class="mt-1 text-sm text-gray-600">Total Entries: <span id="entryCount">0</span></p>
      </div>
      <div class="flex flex-col sm:flex-row sm:items-center gap-2 w-full sm:w-auto">
        <div class="flex items-center gap-2">
          <div id="topDeleteIcon" title="Delete Selected Row"
              class="hidden text-red-500 hover:text-red-700 text-2xl cursor-pointer">
            üóëÔ∏è
          </div>
          <input type="date" id="entryDate" class="border rounded px-3 py-2 text-base w-full sm:w-auto" />
        </div>
        <button onclick="addEntry()" class="bg-blue-500 text-white px-4 py-2 rounded w-full sm:w-auto">
          Add Entry
        </button>
      </div>
    </div>
  </div>

  <!-- Entry Section -->
  <div class="bg-white shadow rounded-lg p-4">
    <div class="hidden sm:grid grid-cols-4 font-semibold mb-2 gap-2">
      <span>Customer Name</span>
      <span>Time</span>
      <span>Driver Name</span>
      <span></span>
    </div>
    <div id="entriesContainer" class="overflow-y-auto pr-1 max-h-[calc(100vh-220px)] sm:max-h-[70vh]"></div>
  </div>

  <!-- Custom A2HS Button -->
  <button id="installBtn" class="fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow hidden">
    üì≤ Install LDC Notebook
  </button>

  <script>
    const entryDate = document.getElementById('entryDate');
    const entriesContainer = document.getElementById('entriesContainer');
    const entryCount = document.getElementById('entryCount');
    const topDeleteIcon = document.getElementById('topDeleteIcon');
    const syncStatus = document.getElementById('syncStatus');
    const installBtn = document.getElementById('installBtn');

    let selectedRow = null;
    let deferredPrompt = null;

    entryDate.valueAsDate = new Date();
    entryDate.addEventListener('change', loadEntries);

    const SYNC_URL = "https://script.google.com/macros/s/.../exec"; // your sync URL here

    // IndexedDB setup using idb-keyval
    const storeName = 'ldc-entries';
    const dbPromise = indexedDB.open('ldcNotebook', 1);
    dbPromise.onupgradeneeded = function(e) {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(storeName)) {
        db.createObjectStore(storeName);
      }
    };

    function idbSet(key, val) {
      return dbPromise.result.transaction([storeName], 'readwrite')
        .objectStore(storeName).put(val, key);
    }

    function idbGet(key, callback) {
      const tx = dbPromise.result.transaction([storeName], 'readonly');
      const req = tx.objectStore(storeName).get(key);
      req.onsuccess = () => callback(req.result || []);
    }

    function getStorageKey() {
      return `entries-${entryDate.value}`;
    }

    function loadEntries() {
      entriesContainer.innerHTML = '';
      selectedRow = null;
      hideTopDelete();

      idbGet(getStorageKey(), (saved) => {
        saved.sort((a, b) => a.time.localeCompare(b.time));
        saved.forEach(entry => createEntryElement(entry.customer, entry.time, entry.driver));
        updateCount();
      });
    }

    function saveEntries() {
      const entries = [];
      entriesContainer.querySelectorAll('.entry-row').forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        entries.push({
          customer: inputs[0].value,
          time: inputs[1].value,
          driver: inputs[2].value
        });
      });
      idbSet(getStorageKey(), entries);
      loadEntries();
    }

    function createEntryElement(customer = '', time = '', driver = '') {
      const div = document.createElement('div');
      div.className = 'grid grid-cols-1 sm:grid-cols-4 gap-2 mb-4 p-2 rounded entry-row items-center relative';
      div.onclick = (e) => {
        if (["INPUT", "SELECT", "BUTTON"].includes(e.target.tagName)) return;
        selectRow(div);
      };

      div.innerHTML = `
        <div class="relative">
          <input type="text" class="border px-3 py-2 rounded w-full pr-10" placeholder="Customer Name" value="${customer}" onchange="saveEntries()" />
          <button title="Add to Contacts" class="absolute right-2 top-2 text-green-600 text-xl" onclick="event.stopPropagation(); downloadContact(this)">‚ûï</button>
        </div>
        <select class="border px-3 py-2 rounded w-full" onchange="saveEntries()">
          ${generateTimeOptions(time)}
        </select>
        <input type="text" class="border px-3 py-2 rounded w-full" placeholder="Driver Name" value="${driver}" onchange="saveEntries()" />
        <div></div>
      `;

      entriesContainer.appendChild(div);
      updateCount();
    }

    function generateTimeOptions(selected = '') {
      const options = [];
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 30) {
          const val = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
          const hour12 = h % 12 === 0 ? 12 : h % 12;
          const ampm = h < 12 ? 'AM' : 'PM';
          options.push(`<option value="${val}" ${selected === val ? 'selected' : ''}>${hour12}:${m.toString().padStart(2, '0')} ${ampm}</option>`);
        }
      }
      return options.join('');
    }

    function addEntry() { createEntryElement(); }

    function deleteSelectedRow() {
      if (selectedRow) {
        selectedRow.remove();
        selectedRow = null;
        hideTopDelete();
        updateCount();
        saveEntries();
      }
    }

    function updateCount() {
      entryCount.textContent = entriesContainer.querySelectorAll('.entry-row').length;
    }

    function selectRow(row) {
      document.querySelectorAll('.entry-row').forEach(r => r.classList.remove('selected'));
      selectedRow = row;
      row.classList.add('selected');
      showTopDelete();
    }

    function showTopDelete() { topDeleteIcon.classList.remove('hidden'); }
    function hideTopDelete() { topDeleteIcon.classList.add('hidden'); }

    topDeleteIcon.addEventListener('click', deleteSelectedRow);

    function downloadContact(button) {
      const row = button.closest('.entry-row');
      const inputs = row.querySelectorAll('input, select');
      const name = inputs[0].value.trim();
      const driver = inputs[2].value.trim();

      if (!name) return alert("Customer name is required to add to contacts.");

      const vcf = `BEGIN:VCARD\nVERSION:3.0\nFN:${name}\nORG:LDC Notebook\nNOTE:Driver: ${driver}\nEND:VCARD`;
      const blob = new Blob([vcf], { type: 'text/vcard' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name.replace(/\s+/g, '_')}.vcf`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateSyncStatus(status, color) {
      syncStatus.textContent = status;
      syncStatus.style.backgroundColor = color;
      syncStatus.classList.remove('hidden');
      setTimeout(() => syncStatus.classList.add('hidden'), 3000);
    }

    function syncToGoogleSheet() {
      if (!navigator.onLine) return updateSyncStatus('‚ùå Offline: Sync Skipped', '#ef4444');

      const entries = [];
      const currentDate = entryDate.value;

      entriesContainer.querySelectorAll('.entry-row').forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        entries.push({
          date: currentDate,
          customer: inputs[0].value,
          time: inputs[1].value,
          driver: inputs[2].value
        });
      });

      updateSyncStatus('üîÑ Syncing...', '#3b82f6');
      fetch(SYNC_URL, {
        method: "POST",
        body: JSON.stringify(entries),
        headers: { "Content-Type": "application/json" }
      }).then(() => {
        updateSyncStatus('‚úÖ Synced to Google Sheet', '#10b981');
      }).catch(() => {
        updateSyncStatus('‚ùå Sync Failed', '#ef4444');
      });
    }

    setInterval(syncToGoogleSheet, 30000);

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.classList.remove('hidden');
    });

    installBtn.addEventListener('click', () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
          deferredPrompt = null;
          installBtn.classList.add('hidden');
        });
      }
    });

    window.addEventListener('online', () => updateSyncStatus('üü¢ Back Online', '#10b981'));
    window.addEventListener('offline', () => updateSyncStatus('üî¥ Offline Mode', '#ef4444'));

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');

    loadEntries();
  </script>
</body>
</html>
